<!doctype html>
<html>
<link rel="stylesheet" type="text/css" href="./stylesheets/blackJack.css">
<body>
    <div id="board">
        <div id="my_poker" ></div>
    </div>
    <div class="score">
        <span>Bank's points: <span id="bank_point">0</span></span>
        <span>Own points: <span id="own_point">0</span></span>
    </div>
    <div id="actions">
        <span id="stand">Stand</span>
    </div>

    <script type="text/javascript">
        !function(){
            'use strict'
            var Poker = (function(){
                var board = document.getElementById('board'),
                    my_poker = document.getElementById('my_poker'),
                    own_point = document.getElementById('own_point'),
                    bank_point = document.getElementById('bank_point'),
                    ac_stand = document.getElementById('stand'),
                    point = 1,
                    suit,
                    check_poker = [],
                    createNode= function (This) {
                        This.node = document.createElement('div'),
                        This.node2 = document.createElement('div')
                        This.node.setAttribute('class', 'poker')

                        board.appendChild(This.node)

                        This.node2.setAttribute('class', 'back')
                        This.node.appendChild(This.node2)
                    },
                    checkPoint = function (This) {
                        var temp_count_point = 0

                        point = Math.floor((Math.random()*13)+1)

                        //check the auto next point 
                        temp_count_point = This.total_points + (point > 10 ? 10 : point)
                        if ( This.auto && temp_count_point > 21 ) This.turn_poker = 0
                    },
                    checkPoker = function (This) {
                        var check_str = ''
                        suit = ['spades', 'hearts', 'diamonds', 'clubs'][Math.floor((Math.random()*4))] || 'spades'
                        check_str = suit + '_' + point
                        console.log(point)

                        if ( check_poker.indexOf(check_str) > -1 ) {
                            checkPoint(This)
                            checkPoker(This)
                            return 
                        }

                        This.total_points += (point > 10 ? 10 : point)
                        check_poker.push(check_str)
                        console.log(check_poker)
                    },
                    wrapFnc = function (fnc, This) {
                        return function () {
                            fnc(This)
                        }
                    },
                    timeoutFnc = function (fnc, time) {
                        setTimeout(fnc, time)
                    },
                    movePoker = function (This) {
                        This.node.className += ' trans_1s move'
                        if ( This.auto ) This.node.className += ' bank_move'
                        timeoutFnc(wrapFnc(turnPoker, This), 500)
                    },
                    turnPoker = function (This) {
                        This.node2.className += ' turn trans_1s suits-' + point
                        timeoutFnc(wrapFnc(addSuit, This), 1000)
                    },
                    addSuit = function (This) {
                        This.node2.className += ' turn_back ' + suit
                        This.turn_poker = 1
                        This.point_obj.innerHTML = This.total_points

                        checkBust(This)
                        if ( This.auto ) This.action(This)
                    },
                    checkBust = function (This) {
                        if ( This.total_points == 21 ||  (This.total_points < 21 && This.idx == 5) ) {
                            This.turn_poker = 0
                            alert('Winner!')
                        } else if ( This.total_points > 21 ) {
                            This.turn_poker = 0
                            alert('Over!')
                        }
                    },
                    checkWinner = function (This) {
                        if ( This.turn_poker ) {
                            var own_score = +own_point.innerHTML,
                                bank_score = +bank_point.innerHTML

                            This.turn_poker = 0

                            if ( (own_score >= bank_score && own_score <= 21) || This.idx == 5 ) {
                                alert('Winner!')
                            } else {
                                alert('Loser!')
                            }
                        }
                    }

                var Poker = function () {
                    this.total_points = 0
                    this.idx = 0
                    this.turn_poker = 1

                    ac_stand.addEventListener('click', wrapFnc(checkWinner, this), false)
                }

                // Poker.prototype.start = function (auto) {
                //     var This = this
                //     This.auto = auto
                //     if ( auto ){
                //         action(This)
                //     } else {
                //         my_poker.addEventListener('click', function () { action(This) }, false)
                //     }
                //     This.point_obj = auto ? bank_point : own_point
                // }
                Poker.prototype.action = function (This) {
                    console.log('*** %o' , This)
                    checkPoint(This)
                    if ( This.turn_poker && This.idx < 5 ) {
                        if ( This.total_points > 21 ) return

                        This.turn_poker = 0
                        createNode(This)
                        
                        This.idx++
                        checkPoker(This)
                        timeoutFnc(wrapFnc(movePoker, This), 300)
                    }
                }
                return Poker
            })()
            var Player = new Poker()
            var Bank = new Poker()

            // Player.start(0)
            // Bank.start(1)
            Bank.auto = 1
            Bank.point_obj = document.getElementById('bank_point')
            Bank.action(Bank) 

        }()
    </script>
</body>
</html>